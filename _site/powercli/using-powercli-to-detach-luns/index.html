<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Using PowerCLI to Detach Luns &#8211; davidstamen.com</title>
<meta name="description" content="I thought I would share this script, its been circulating a bit but I feel it is a nice one to have in your toolkit.

">
<meta name="keywords" content="">


<!-- Twitter Cards -->
<meta name="twitter:title" content="Using PowerCLI to Detach Luns">
<meta name="twitter:description" content="I thought I would share this script, its been circulating a bit but I feel it is a nice one to have in your toolkit.

">
<meta name="twitter:site" content="@davidstamen">
<meta name="twitter:creator" content="@davidstamen">

<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="/images/default-thumb.png">


<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Using PowerCLI to Detach Luns">
<meta property="og:description" content="I thought I would share this script, its been circulating a bit but I feel it is a nice one to have in your toolkit.

">
<meta property="og:url" content="/powercli/using-powercli-to-detach-luns/">
<meta property="og:site_name" content="davidstamen.com">

<meta property="og:image" content="/images/default-thumb.png">







<link rel="canonical" href="/powercli/using-powercli-to-detach-luns/">
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="davidstamen.com Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
	<script src="/assets/js/vendor/html5shiv.min.js"></script>
	<script src="/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>

<link href='//fonts.googleapis.com/css?family=PT+Sans+Narrow:400,700%7CPT+Serif:400,700,400italic' rel='stylesheet' type='text/css'>

<!-- Icons-->
<link rel="shortcut icon" href="/favicon.ico">
<link rel="shortcut icon" href="/favicon.png">
<link rel="icon" href="/favicon.ico">
<link rel="icon" href="/favicon.png">
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png">
<link rel="apple-touch-icon" sizes="57x57" href="/images//apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/images//apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/images//apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/images//apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/images//apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/images//apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/images//apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/images//apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images//apple-touch-icon-180x180.png">

</head>

<body class="post">

<!--[if lt IE 9]><div class="browser-upgrade alert alert-info">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]-->

<div class="navigation-wrapper">
	<div class="site-name">
		<a href="/">davidstamen.com</a>
	</div><!-- /.site-name -->
	<div class="top-navigation">
		<nav role="navigation" id="site-nav" class="nav">
		    <ul>
		        
				    
				    <li><a href="/categories/" >Categories</a></li>
				
				    
				    <li><a href="/posts/" >Posts</a></li>
				
				    
				    <li><a href="/resources/" >Resources</a></li>
				
				    
				    <li><a href="/acclaim/" >Acclaim</a></li>
				
				    
				    <li><a href="/search/" >Search</a></li>
				
		    </ul>
		</nav>
	</div><!-- /.top-navigation -->
</div><!-- /.navigation-wrapper -->



<div id="main" role="main">
  <div class="article-author-side">
    

<div itemscope itemtype="http://schema.org/Person">


	<img src="/images/me.jpeg" class="bio-photo" alt="David Stamen bio photo">

  <h4 itemprop="name">David Stamen</h4>
  <p>Senior Virtualization Engineer
  <br><br>VCAP-DCA | MCSA | VMware vExpert
</p>
  <a href="mailto:dstamen@gmail.com" class="author-social" target="_blank"><i class="fa fa-fw fa-envelope-square"></i> Email</a>
  <a href="http://twitter.com/davidstamen" class="author-social" target="_blank"><i class="fa fa-fw fa-twitter-square"></i> Twitter</a>
  
  
  <a href="http://linkedin.com/in/davidstamen" class="author-social" target="_blank"><i class="fa fa-fw fa-linkedin-square"></i> LinkedIn</a>
  
  
  
  <a href="http://github.com/dstamen" class="author-social" target="_blank"><i class="fa fa-fw fa-github"></i> Github</a>
  
  
  
  
  
  
  
  
  
  
  
</div>

  </div>
  <article class="post">
    <div class="headline-wrap">
      
        <h1><a href="/powercli/using-powercli-to-detach-luns/" rel="bookmark" title="Using PowerCLI to Detach Luns">Using PowerCLI to Detach Luns</a></h1>
      
    </div><!--/ .headline-wrap -->
    <div class="article-wrap">
      <p>I thought I would share this script, its been circulating a bit but I feel it is a nice one to have in your toolkit.</p>

<p>Have you ever had to remove a LUN from a cluster and thought “Do I really need to detach all the LUN’s, before un-mapping from my SAN?”</p>

<ol>
  <li>Unmount Datastore</li>
  <li>Detach LUN</li>
  <li>Un-map from SAN</li>
  <li>Rescan Cluster</li>
</ol>

<p>Well here is a handy script with output. All you need to do is unmount your datastore(s), and then enter in your naaid of your LUN’s and the cluster you want to remove it from, save it an execute. All the LUN’s will be detached without having to manually go and detach it from every LUN in your cluster.</p>

<p>The code and Github Link can be found below.</p>

<p><a href="https://github.com/dstamen/PowerCLI/blob/master/Detach-SCSILun.ps1">Detach-ScsiLun.ps1</a></p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="c1"># PowerCLI Script for detaching luns from a cluster</span>
<span class="c1"># @davidstamen</span>
<span class="c1"># http://davidstamen.com</span>

<span class="nv">$LunIDs</span> <span class="o">=</span> <span class="s2">"naa.6000000001"</span>,<span class="s2">"naa.600000002"</span>
<span class="nv">$Clustername</span> <span class="o">=</span> <span class="s2">"MyCluster"</span>

<span class="k">function </span>Detach-Disk <span class="o">{</span>
    <span class="k">param</span><span class="o">(</span>
        <span class="o">[</span>VMware.VimAutomation.ViCore.Impl.V1.Inventory.VMHostImpl]<span class="nv">$VMHost</span>,
        <span class="o">[</span><span class="kt">string</span><span class="o">]</span><span class="nv">$CanonicalName</span>    <span class="o">)</span>

    <span class="nv">$storSys</span> <span class="o">=</span> Get-View <span class="nv">$VMHost</span>.Extensiondata.ConfigManager.StorageSystem
    <span class="nv">$lunUuid</span> <span class="o">=</span> <span class="o">(</span>Get-ScsiLun -VmHost <span class="nv">$VMHost</span> | <span class="nb">where</span> <span class="o">{</span><span class="nv">$_</span>.CanonicalName -eq <span class="nv">$CanonicalName</span><span class="o">})</span>.ExtensionData.Uuid

    <span class="nv">$storSys</span>.DetachScsiLun<span class="o">(</span><span class="nv">$lunUuid</span><span class="o">)</span>
<span class="o">}</span>

<span class="nv">$ClusterHosts</span> <span class="o">=</span> Get-Cluster <span class="nv">$Clustername</span> | Get-VMHost

<span class="k">Foreach</span><span class="o">(</span><span class="nv">$VMHost</span> <span class="k">in</span> <span class="nv">$ClusterHosts</span><span class="o">)</span>
<span class="o">{</span>
    <span class="k">Foreach</span><span class="o">(</span><span class="nv">$LUNid</span> <span class="k">in</span> <span class="nv">$LunIDs</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="nb">Write-Host</span> <span class="s2">"Detaching"</span> <span class="nv">$LUNid</span> <span class="s2">"from"</span> <span class="nv">$VMHost</span> -ForegroundColor <span class="s2">"Yellow"</span>
        Detach-Disk -VMHost <span class="nv">$VMHost</span> -CanonicalName <span class="nv">$LUNid</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>


      <hr />
      <footer role="contentinfo">
        <div class="social-share">
  <h4>Share on</h4>
  <ul>
    <li>
      <a href="https://twitter.com/intent/tweet?url=/powercli/using-powercli-to-detach-luns/&text=Using PowerCLI to Detach Luns&via=davidstamen" target="_blank"><i class="fa fa-twitter-square fa-2x"></i></a>
    </li>
    <li>
      <a href="https://www.facebook.com/sharer/sharer.php?u=/powercli/using-powercli-to-detach-luns/" class="tumbler" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
    </li>
    <li>
      <a href="https://plus.google.com/share?url=/powercli/using-powercli-to-detach-luns/" class="tumbler" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a>
    </li>
    <li>
      <a href="http://www.linkedin.com/shareArticle?mini=true&url=/powercli/using-powercli-to-detach-luns/" class="tumbler" title="Share on LinkedIn"><i class="fa fa-fw fa-linkedin-square fa-2x"></i></a>
    </li>
    <li>
      <a href="http://www.reddit.com/submit?url=/powercli/using-powercli-to-detach-luns/&title=Using PowerCLI to Detach Luns" class="tumbler" title="Share on Reddit"><i class="fa fa-fw fa-reddit-square fa-2x"></i></a>
    </li>
  </ul>
</div><!-- /.social-share -->

        <p class="byline"><strong>Using PowerCLI to Detach Luns</strong> was published on <time datetime="2015-09-14T00:00:00-04:00">September 14, 2015</time>.</p>
      </footer>
    </div><!-- /.article-wrap -->
  
    <section id="disqus_thread"></section><!-- /#disqus_thread -->
  
  </article>
</div><!-- /#main -->

<div class="footer-wrap">
  
  <div class="related-articles">
  <h4>You might also enjoy <small class="pull-right">(<a href="/posts/">View all posts</a>)</small></h4>
    <ul>
    
      <li><a href="/vrealize%20operations/using-powercli-to-add-vrealize-operations-license-key/" title="Using PowerCLI to Add vRealize Operations License Key">Using PowerCLI to Add vRealize Operations License Key</a></li>
    
      <li><a href="/vrealize%20operations/using-postman-to-add-vrealize-operations-license-key/" title="Using PostMan to Add vRealize Operations License Key">Using PostMan to Add vRealize Operations License Key</a></li>
    
      <li><a href="/ubiquiti/configuring-unifi-controller-and-usg-for-l2tp-vpn/" title="Configuring Unifi Controller and USG for L2TP VPN">Configuring Unifi Controller and USG for L2TP VPN</a></li>
    
    </ul>
    <hr />
  </div><!-- /.related-articles -->
  
  <footer>
    

<span>&copy; 2017 David Stamen. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a></span>

  </footer>
</div><!-- /.footer-wrap -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="/assets/js/scripts.min.js"></script>

<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl =
 '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'UA-67336507-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>


  
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'davidstamen'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>




</body>
</html>
